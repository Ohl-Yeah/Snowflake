
WITH REFD_OBJECTS AS
(
    SELECT   REFERENCED_OBJECT_ID
            ,CONCAT( REFERENCED_DATABASE, '.', REFERENCED_SCHEMA, '.', REFERENCED_OBJECT_NAME ) AS REFERENCED_OBJECT
            ,REFERENCED_DATABASE
            ,REFERENCED_SCHEMA
            ,REFERENCED_OBJECT_NAME
            ,COUNT( REFERENCED_OBJECT_ID ) AS "NUMBER_OF_REFERENCES"
    FROM    SNOWFLAKE.ACCOUNT_USAGE.OBJECT_DEPENDENCIES
    WHERE   REFERENCED_OBJECT_DOMAIN = 'TABLE'
        AND REFERENCED_DATABASE = 'ERP_STAGING_PROD'
    GROUP BY
             REFERENCED_OBJECT_ID
            ,CONCAT( REFERENCED_DATABASE, '.', REFERENCED_SCHEMA, '.', REFERENCED_OBJECT_NAME )
            ,REFERENCED_DATABASE
            ,REFERENCED_SCHEMA
            ,REFERENCED_OBJECT_NAME
),
ALL_OBJECTS AS
(
    SELECT   TABLE_ID
            ,CONCAT( TABLE_CATALOG, '.', TABLE_SCHEMA, '.', TABLE_NAME ) AS "TABLE_REFERENCE"
            ,TABLE_CATALOG
            ,TABLE_SCHEMA
            ,TABLE_NAME
            ,ROW_COUNT
            ,BYTES
    FROM    SNOWFLAKE.ACCOUNT_USAGE.TABLES
    WHERE   TABLE_TYPE = 'BASE TABLE'
        AND TABLE_CATALOG = 'ERP_STAGING_PROD'
        AND TABLE_SCHEMA NOT LIKE 'FIVETRAN_TESTING%'
)
SELECT   TABLE_ID AS "OBJECT_ID"
        ,TABLE_REFERENCE
        ,TABLE_CATALOG AS DATABASE
        ,TABLE_SCHEMA AS SCHEMA
        ,TABLE_NAME
        ,CASE
            WHEN REFERENCED_OBJECT_ID IS NULL THEN FALSE
            ELSE TRUE
         END AS IS_REFERENCED
        ,CASE
            WHEN REFERENCED_OBJECT_ID IS NULL THEN 0
            ELSE NUMBER_OF_REFERENCES
         END AS NUMBER_OF_REFERENCES
        ,ROW_COUNT
        ,BYTES
        ,BYTES * 0.000001 AS MEGA_BYTES
        ,BYTES * 0.000000001 AS GIGA_BYTES
FROM    ALL_OBJECTS 
        LEFT OUTER JOIN REFD_OBJECTS
            ON ALL_OBJECTS.TABLE_ID = REFD_OBJECTS.REFERENCED_OBJECT_ID
